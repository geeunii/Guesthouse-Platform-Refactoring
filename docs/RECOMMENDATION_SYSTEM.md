# 게하방 추천 시스템 (Recommendation System)

사용자 맞춤형 숙소 추천 기능에 대한 기술 문서입니다.

---

## 📌 개요

사용자의 **선호 테마**와 **리뷰 태그**를 기반으로 맞춤형 숙소를 추천합니다.  
Content-Based Filtering 방식을 사용하며, 여러 요소에 가중치를 적용한 하이브리드 스코어링을 수행합니다.

---

## 🔧 API 사용법

### Endpoint
```
GET /api/recommendations?userId={userId}&limit={limit}
```

### Parameters
| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `userId` | Long | ✅ | 추천받을 사용자 ID |
| `limit` | int | ❌ | 추천 개수 (기본값: 10) |

### Response 예시
```json
{
  "success": true,
  "count": 3,
  "recommendations": [
    {
      "accommodationId": 42,
      "accommodationName": "해변 게스트하우스",
      "shortDescription": "바다가 보이는 아늑한 숙소",
      "city": "부산",
      "district": "해운대구",
      "imageUrl": "https://...",
      "rating": 4.5,
      "minPrice": 35000,
      "score": 0.78,
      "matchedThemes": ["바다뷰", "조용한"],
      "matchedTags": ["친절한 호스트", "청결함"]
    }
  ]
}
```

---

## 📊 추천 알고리즘

### 점수 계산 공식

```
최종 점수 = (테마 점수 × 0.40) + (태그 점수 × 0.35) + (평점 점수 × 0.25)
```

### 가중치
| 요소 | 가중치 | 설명 |
|------|--------|------|
| 테마 매칭 | 40% | 사용자 선호 테마와의 일치도 |
| 태그 매칭 | 35% | 사용자가 높게 평가한 리뷰 태그 |
| 평점 | 25% | 숙소 평점 (베이지안 평균 적용) |

---

## 🧮 세부 점수 계산

### 1. 테마 점수 (Jaccard Similarity)
사용자 선호 테마와 숙소 테마 간의 유사도를 계산합니다.

```
Jaccard = 교집합 / 합집합
        = 매칭 테마 수 / (사용자 테마 수 + 숙소 테마 수 - 매칭 수)
```

**예시**: 사용자가 [바다뷰, 조용한, 가성비] 선호, 숙소가 [바다뷰, 조용한] 보유
- 교집합: 2개
- 합집합: 3 + 2 - 2 = 3개
- Jaccard = 2/3 ≈ 0.67

### 2. 태그 점수
사용자가 4점 이상 준 리뷰의 태그와 숙소의 리뷰 태그 매칭 수를 계산합니다.

```
태그 점수 = min(매칭 태그 수 / 5, 1.0)
```

최대 5개 매칭 시 1.0점 (정규화)

### 3. 평점 점수 (Bayesian Average)
리뷰 수가 적은 숙소의 평점 편향을 보정합니다.

```
베이지안 평점 = (리뷰수 × 평점 + C × m) / (리뷰수 + C)

C = 5 (가중치)
m = 4.0 (전체 평균 추정값)
```

**예시**: 
- 신규 숙소 (리뷰 1개, 평점 5.0) → 베이지안 = (1×5 + 5×4) / 6 ≈ **4.17**
- 인기 숙소 (리뷰 100개, 평점 4.2) → 베이지안 = (100×4.2 + 5×4) / 105 ≈ **4.19**

---

## 🗂️ 데이터 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    추천 요청 (userId)                        │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
     ┌─────────────────────────────────────────────┐
     │  1. 사용자 선호 테마 조회 (user_theme)       │
     │  2. 사용자 선호 태그 조회 (review + 4점↑)   │
     │  3. 이미 예약한 숙소 ID 조회 (제외 목적)    │
     └──────────────────────────┬──────────────────┘
                                ▼
     ┌─────────────────────────────────────────────┐
     │  4. 테마 기반 숙소 후보 조회                │
     │  5. 태그 기반 숙소 후보 조회                │
     └──────────────────────────┬──────────────────┘
                                ▼
     ┌─────────────────────────────────────────────┐
     │  6. 점수 계산 및 병합                       │
     │     - 테마 Jaccard Similarity               │
     │     - 태그 매칭 점수                        │
     │     - 베이지안 평점                         │
     └──────────────────────────┬──────────────────┘
                                ▼
     ┌─────────────────────────────────────────────┐
     │  7. 가중합 → 최종 점수 내림차순 정렬        │
     │  8. 테마/태그 이름 추가 후 반환             │
     └─────────────────────────────────────────────┘
```

---

## 📁 관련 파일

### Backend
| 파일 | 설명 |
|------|------|
| `RecommendationController.java` | API 엔드포인트 |
| `RecommendationService.java` | 서비스 인터페이스 |
| `RecommendationServiceImpl.java` | 추천 로직 구현 |
| `RecommendationMapper.java` | MyBatis 매퍼 인터페이스 |
| `RecommendationMapper.xml` | SQL 쿼리 정의 |
| `RecommendationResponse.java` | 응답 DTO |
| `AccommodationScoreDto.java` | 점수 계산용 DTO |

### Frontend
| 파일 | 설명 |
|------|------|
| `recommendation.js` | API 호출 함수 |

---

## 🔒 제외 조건

- **이미 예약한 숙소**: 중복 추천 방지
- **비활성 숙소**: `accommodation_status != 1`
- **미승인 숙소**: `approval_status != 'APPROVED'`

---

## � Fallback 로직 (신규 사용자용)

사용자가 선호 테마를 선택하지 않았고, 4점 이상 리뷰도 없는 경우:

### 동작 방식
```
선호 테마 없음 AND 선호 태그 없음
       ↓
인기 숙소 기반 추천 (Fallback)
```

### Fallback 점수 계산
```
인기도 점수 = (예약 수 점수 × 0.50) + (평점 점수 × 0.50)

- 예약 수 점수: min(예약 수 / 50, 1.0)
- 평점 점수: 베이지안 평균 / 5.0
```

### 정렬 기준
1. 예약 수 (많은 순)
2. 평점 (높은 순)
3. 등록일 (최신 순)

---

## �💡 향후 개선 아이디어

1. **협업 필터링**: 비슷한 사용자의 예약 패턴 기반 추천
2. **시즌별 가중치**: 계절/휴가 시즌 반영
3. **위치 기반**: 사용자 최근 검색 지역 우선
4. **실시간 인기도**: 최근 예약/조회 수 반영
