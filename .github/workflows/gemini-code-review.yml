name: Gemini Code Review (Manual)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review (e.g. 123)"
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number(core.getInput('pr_number'));
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('pr_number', prNumber);

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ steps.pr.outputs.base_ref }}
          git fetch origin ${{ steps.pr.outputs.head_sha }}

          DIFF=$(git diff origin/${{ steps.pr.outputs.base_ref }}...${{ steps.pr.outputs.head_sha }} -- '*.java' '*.yml' '*.properties' | head -c 30000)

          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "review=API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ -z "$DIFF_CONTENT" ]; then
            echo "review=ë³€ê²½ëœ ì½”ë“œê°€ ì—†ê±°ë‚˜ íŒŒì¼ í™•ì¥ìê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 0
          fi

          PAYLOAD=$(jq -n --arg diff "$DIFF_CONTENT" '{
            "contents": [{
              "parts": [{
                "text": ("ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ë°±ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤. ì•„ë˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.\n\në¦¬ë·° ê¸°ì¤€:\n1. ë²„ê·¸ ê°€ëŠ¥ì„±\n2. ë³´ì•ˆ ì·¨ì•½ì \n3. ì„±ëŠ¥ ì´ìŠˆ\n4. ì½”ë“œ ìŠ¤íƒ€ì¼/ê°€ë…ì„±\n5. ê°œì„  ì œì•ˆ\n\ní•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”. ë¬¸ì œê°€ ì—†ìœ¼ë©´ \"LGTM\"ì´ë¼ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.\n\n```diff\n" + $diff + "\n```")
              }]
            }],
            "generationConfig": { "temperature": 0.2, "maxOutputTokens": 2048 }
          }')

          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}"  \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR_MSG" ]; then
            echo "review=API ì˜¤ë¥˜ ë°œìƒ: $ERROR_MSG" >> $GITHUB_OUTPUT
            exit 0
          fi

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "ë¦¬ë·° ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."' )

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.review.outputs.review != ''
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ¤– Gemini ì½”ë“œ ë¦¬ë·° (Manual)

            ${{ steps.review.outputs.review }}

            ---
            *ì´ ë¦¬ë·°ëŠ” ìˆ˜ë™ ì‹¤í–‰ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•´ì£¼ì„¸ìš”.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.pr.outputs.pr_number }}"),
              body
            });
